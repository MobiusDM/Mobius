---
name: Attest Windows binaries with GitHub's free signing

on:
  workflow_call:
    inputs:
      filename:
        description: 'The name of the file to attest'
        required: true
        type: string
      download_name:
        description: 'The name of the artifact to download'
        required: false
        default: 'unsigned-windows'
        type: string
      upload_name:
        description: 'The name of the artifact to upload'
        required: false
        default: 'attested-windows'
        type: string
    # Note: No secrets required - using GitHub's free attestation

permissions:
  contents: read
  id-token: write  # Required for GitHub attestation
  attestations: write  # Required for GitHub attestation

jobs:
  attest-windows:
    runs-on: ubuntu-latest
    steps:


      - name: Download unsigned artifact
        uses: actions/download-artifact@abefc31eafcfbdf6c5336127c1346fdae79ff41c # v5.0.0
        with:
          name: ${{ inputs.download_name }}

      - name: Attest build provenance
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2.0
        with:
          subject-path: ${{ inputs.filename }}

      - name: Set variables
        id: variables
        run: |
          echo "SM_HOST=${{ secrets.DIGICERT_KEYLOCKER_HOST_URL }}" >> "$GITHUB_ENV"
          echo "SM_API_KEY=${{ secrets.DIGICERT_API_KEY }}" >> "$GITHUB_ENV"
          echo "SM_CLIENT_CERT_FILE=D:\\Certificate_pkcs12.p12" >> "$GITHUB_ENV"
          echo "SM_CLIENT_CERT_PASSWORD=${{ secrets.DIGICERT_KEYLOCKER_PASSWORD }}" >> "$GITHUB_ENV"
      - name: Upload attested artifact
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # 4.3.3
        with:
          name: ${{ inputs.upload_name }}
          path: ${{ inputs.filename }}
